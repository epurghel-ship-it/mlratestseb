# app.py
import streamlit as st
import pandas as pd
from openai import OpenAI

# Initialize OpenAI client
client = OpenAI(api_key="YOUR_OPENAI_API_KEY")  # Replace with your key

st.title("Corporate Action Validator")

# 1️⃣ Upload CSV
uploaded_file = st.file_uploader("Upload your CSV", type="csv")
if uploaded_file:
    df = pd.read_csv(uploaded_file)
    st.write("Preview of your data:", df.head())

    results = {}

    # 2️⃣ Process each entity
    for entity_id, group in df.groupby("RP_ENTITY_ID"):
        company = group["RP_ENTITY_NAME"].iloc[0]
        event_date = group["RANGE_END_STG"].dropna().iloc[0]

        # 2a. Classify corporate action
        prompt = f"""
        The company '{company}' has securities ending on {event_date}.
        Task: Identify the most likely corporate action.
        Return one of: STOCK_SPLIT, REVERSE_SPLIT, DELISTING, MERGER, ACQUISITION, REDEMPTION, REORGANIZATION, NAME_CHANGE, INSUFFICIENT_EVIDENCE
        """
        response = client.responses.create(model="gpt-4.1-mini", input=prompt)
        action = response.output_text.strip()

        # 2b. Validate corporate action
        prompt_val = f"""
        The company '{company}' has securities ending on {event_date}.
        Identified corporate action: {action}
        Task: Validate if this action is correct.
        Return one of: CORRECT, INCORRECT, INSUFFICIENT_EVIDENCE
        """
        response_val = client.responses.create(model="gpt-4.1-mini", input=prompt_val)
        validation = response_val.output_text.strip()

        results[entity_id] = {"CORP_ACTION": action, "CHANGE_VALIDATION": validation}

    # 3️⃣ Add results to df
    df["CORP_ACTION"] = df["RP_ENTITY_ID"].map(lambda x: results[x]["CORP_ACTION"])
    df["CHANGE_VALIDATION"] = df["RP_ENTITY_ID"].map(lambda x: results[x]["CHANGE_VALIDATION"])

    st.write("Enriched data:", df)

    # 4️⃣ Download button
    csv = df.to_csv(index=False).encode("utf-8")
    st.download_button("Download CSV", csv, "corporate_action_enriched.csv", "text/csv")
